# 项目上线回溯总结

伴随着PDF转WORD项目来到了第一期节点，项目终于上线了。  
本项目对我而言是一次深入学习和成长的机会，也是对职业生涯的一次洗礼。通过回顾整个开发过程中的挑战、问题和不足，可以让我们更好地理解哪些方面还有待改进。本篇回溯总结尽力梳理项目从启动到一期节点上线的关键或重要问题，分析遇到的问题和基本原因，同时分享我在解决这些问题过程中遇到的经验和教训，更重要的是，基于这些反思做出一系列具体的优化和措施，确保未来的项目能够更加顺利的推进，希望这份总结能对项目团队有所帮助。

## 技术挑战

### 技术问题

在前期调研发现，有能力将pdf文件转word能力的解决方案并不多，在经过转换效果、修改权限和源码自有等多方面评估后，可用的项目仅有一例：基于python语言开发的pdf2docx项目。因此把基于CPython的pdf2docx框架移植到Android平台确定为技术解决方案。因此技术流程确定为：移植CPython解释器到Android平台，在Android平台中使用Java通过JNI连接CPython，由CPython完成对pdf2docx的调用和数据交互，在pdf2docx框架中通过PyMuPDF使用swig集成MuPDF作为PDF驱动，使用集成了lxml的py-docx作为WORD驱动，完成整体功能的实现过程。  
在移植过程中，接触到了较多新技术和新框架，我开展了对新技术研究和探索，包括

1. 适配新版本MuPDF到Android平台，完成从Makefile适配到CMake或Android MK的任务，通过交叉编译链适配到Android，学习MuPDF的基本框架便于裁剪部分内容。  
2. PyMuPDF使用swig集成MuPDF库的过程和原理，将swig生成的目标文件通过交叉编译链适配到Android，然后学习python的安装包结构步骤原理，打包PyMuPDF。  
3. 研究探索CPython作为一个库或模块嵌入式的集成到应用环境。  
4. 研究Android加载native库的原理，集成native库的方式和自定义集成方式。  
5. 掌握pdf2docx项目框架，修改和优化pdf2docx，了解和适当修改优化py-docx库。

我在应用这些技术的过程中遇到了较多的问题和挫折，其中比较典型的如

1. 在适配MuPDF和PyMuPDF过程中犯了一个主要错误：把二者视作一个整体去适配。起初要借助chaquopy的构建系统适配PyMuPDF库，最终实验结果表明，chaquopy使用的系统完善度较低，仅支持标准的小型项目，对包含了额外的构建环境和流程缺乏功能支撑。最终通过先模拟丹哥的编译链适配MuPDF，再剖析和修改PyMuPDF的安装包构建流程，最后完成适配。  
     
   在今后遇到类似比较复杂的场景时，优先分解问题，细化工作，循序渐进，查阅资料或者请教有经验的老师指导方向，根据相关经验或官方文档推进工作，避免走岔路 误工时。  
2. 我发现自己在处理系统加载动态库的技术原理、CPython 和 NumPy 相关库的问题存在不足，以及使用 Android 自定义集成库时遇到了较大挑战。这些问题在需要通过排除法或其他方法解决时，显得尤为困难。  
   为了提升自己的技术水平和工作效率，我制定了改进计划，包括深入学习Linux/Android动态库调用原理，理解ELF文件格式，符号解析过程和依赖关系等，包括研究动态导入的源码，深入学习CPython的源码，特别是配置环境，扩展模块相关的部分，有助于丰富扩展项目功能。  
     
     
3. 前期对pdf2docx及其关联技术实现细节（如pdf中的内容提取和docx文档协议）等投入关注不足，导致后期在提升程序稳定性和转换成功率过程中，暴露出了许多问题。由于前期的技术积累不够深厚，面对这些问题时，无法做到及时响应，工时预估，快速修复和更新迭代，影响了项目整体进度。  
   为了保证未来项目工作更加平稳的推进，我必须做到足够的技术预研和文档学习，例如对PDF核心技术的学习（如字体管理，批注管理，图层图像渲染技术等），对docx文档协议标准进行深入研究，对标竞品，丰富元素类型，完善文档格式。对工时的判断和预估更加细致和准确，实现功能时有技术原理可以依据，提升问题响应速度和工作效率。

### 兼容性问题

由于对动态库的动态加载机制理解不充分，曾在针对armeabi-v7a架构的手机芯片进行开发时，未能预见并避免某些问题的出现：

1. Android armeabi-v7a 架构下的 Numpy 库不兼容  
   在Android的自定义目录集成方式适配工作完成后，Numpy的预编译二进制文件在自定义方式集成时未能正确寻找依赖，从而引发运行时错误，这导致了该架构上的应用无法正常工作。最后在确认了相对导入路径错误后得以解决问题。  
2. Android 5.0和5.1版本集成方式不兼容  
   项目后期，测试发现了与Android 5.0和5.1版本的集成存在兼容性问题。这些较老版本的操作系统对于动态库的动态加载机制支持有限，导致自定义路径集成方式的应用在这些设备上无法正常寻找依赖。我在查阅了了Android Clang编译器的官方文档后，确认问题并增加了向后兼容的解决方案，使用条件编译和预加载处理逻辑，最终解决了此问题。

### 性能瓶颈问题

在优化过程中，内存泄漏问题理应是优先级最高的关注点之一。然而，由于我对垃圾自动回收机制的理解不够深入，在开发和测试阶段未能及时识别和修复这些潜在问题，最终导致它们一直延续到上线前才被发现。

1. 内存泄漏问题  
   在项目后期，东梁反馈了内存泄漏的问题，在多次使用转换功能后，内存会持续升高，影响了应用的其他功能正常运行。  
   我通过使用Valgrind和Android Profiler等内存泄漏检测工具，对代码进行分析，最终修复了所有底层库中的内存泄漏问题。为了确保转换功能不会因内存问题影响到应用的其他业务模块，将使用线程机制修改为了使用子进程执行转换任务的机制。该方案将消耗大量内存和CPU的转换操作发生在子进程中，增强了系统的整体可靠性，最终使主应用进程能够向过往一样保持稳定状态。同时在以后的工作中，训练加强自身对AndroidStudio或其它调试工具的使用，在保质保量完成工作任务的同时做到零泄漏，对集成项目零副作用。不仅如此，主动学习理解垃圾自动回收语言的回收原理，依据编码的规范和准则，提升pdf2docx的转换质量和速度的同时，消除pdf2docx项目中所有内存泄漏。  
2. 转换速度问题  
   在对比竞品时转换速度是劣势的同时，在使用子进程方式执行转换后，每次转换需要完全重新导入CPython环境，这增加了多次转换时的等待时间。  
   为了解决这一瓶颈，我采取了字节码替换源码文件方法减少编译时间的策略。该策略以稍微增加安装包体积为代价，缩短了导入时间，间接提高了转换过程的执行效率，对于旧版本机型优化效果更显著。

## 过程管理

### 沟通问题

1. 语言沟通中的误解风险  
   在应用集成库功能时，集成者发现某些存在的问题反馈到库开发人员这里时，由于通过口头交流描述，而未形成书面记录，可能会导致理解误差或记忆偏差。例如，在讨论转换库在存储满后的错误码检测返回机制时，由于硬盘存储和内存存储都没有相关的机制，可能导致我误以为两种机制都需要增加，从而曲解了需求。  
     
   为了避免这种情况，我们规定所有与需求或问题相关的讨论都必须以文字形式备份到群聊中，确保信息的一致性和可追溯性。  
2. 由于转换库的特殊性，我们目前无法将所有代码集中到同一仓库进行管理，因此也无法使用Git版本管理工具来托管和同步版本。在快速迭代过程中，仅依赖聊天记录来同步版本信息，导致了多个应用集成同一库时出现版本混乱、干扰等问题。这种缺乏严格版本控制的做法，不仅增加了集成的复杂性，还容易引发兼容性和稳定性问题。  
     
   为了解决这一问题，由杨哥牵头建立了一个统一的云盘存储系统，专门用于存放每个版本的库文件及其相关文档。具体措施如下：  
* 版本隔离：每个版本都有独立的文件夹，确保不同版本之间不会相互干扰。  
* 更新文档：每个版本都附带详细的更新日志，明确列出该版本的修改内容、新增功能和修复的Bug，确保开发者能够清楚了解每个版本的具体变化。  
* 版本标识：在云盘中明确标注当前最新的版本，并提供清晰的版本历史记录，方便开发团队快速定位和选择所需的版本。  
  通过这些措施，确保版本信息的一致性，使得上层应用在集成转换库时能够准确获取所需版本，并清楚了解版本更新的内容，从而提升了整体开发效率和产品质量。  
3. 沟通协作中的反馈与改进  
   在迭代过程中，我发现并完善了一些不足之处，但有时未能及时通知相关开发或测试人员。这种做法不仅可能引发新的问题或导致问题回归，还可能使现有问题复杂化，给开发和测试团队带来不必要的干扰。  
     
   为了解决这一问题，我们现在建立了更加严格的沟通机制：任何修改或优化都必须在发版时告知相关人员，并在实施后进行详细的文档记录和跟踪，确保每个改动都能得到充分的验证和确认。